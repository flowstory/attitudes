var Flowstory=function(){"use strict";function o(pr){var yr=Math.floor(d3.now());yr in je&&yr++,je[yr]=pr}function u(){flowData.forEach(function(pr){for(var yr=0,ur=0,hr=0;hr<=Ze;hr++){Pa=Math.min(Pa,pr["in"].all[hr],pr.out.all[hr]),Sa=Math.max(Sa,pr["in"].all[hr],pr.out.all[hr]);var mr=Math.abs(pr["in"].all[hr]-pr.out.all[hr]);mr>Ma&&(Ma=mr),0<mr&&mr<Ca&&(Ca=mr),mr>Ya[hr]&&(Ya[hr]=mr),0<mr&&mr<Ba[hr]&&(Ba[hr]=mr),yr+=pr["in"].all[hr],ur+=pr.out.all[hr]}pr.sum_all_in=yr,pr.sum_all_out=ur,ja=Math.min(ja,yr,ur),Ea=Math.max(Ea,yr,ur);var gr=Math.abs(yr-ur);gr>Ra&&(Ra=gr),0<gr&&gr<Oa&&(Oa=gr),oa.push(pr.cc)}),Fa=Oa,La=Ra}function m(){flowData.forEach(function(pr){var yr=qa([pr.sp.lon,pr.sp.lat]),ur=qa([pr.ep.lon,pr.ep.lat]);pr.sp.x=yr[0],pr.sp.y=yr[1],pr.ep.x=ur[0],pr.ep.y=ur[1];var hr=[ur[0]-yr[0],ur[1]-yr[1]],mr=Math.sqrt(hr[0]*hr[0]+hr[1]*hr[1]),gr=[hr[0]/mr,hr[1]/mr],fr=mr/pr.cp.p,xr=[yr[0]+gr[0]*fr*(pr.cp.p-1),yr[1]+gr[1]*fr*(pr.cp.p-1)],br=Math.PI-Math.atan2(yr[0]-ur[0],yr[1]-ur[1]),vr=[xr[0]-pr.cp.d*Math.cos(br),xr[1]-pr.cp.d*Math.sin(br)];pr.cp_moved=vr,pr.line=Na([yr,vr,ur])})}function g(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0;Ce=Ua.append("g").attr("class","flow_group").style("opacity",yr).style("visibility",pr);var ur=Ua.append("g").attr("class","flow_group_selection").style("opacity",yr).style("visibility",pr),hr=Ce.selectAll("path").data(flowData),mr=ur.selectAll("path").data(flowData);hr.enter().append("path").attr("id",function(gr){return"F_"+gr.cc}).attr("class","flow").attr("d",function(gr){return gr.line}),mr.enter().append("path").attr("id",function(gr){return"FSel_"+gr.cc}).attr("class","flowSel").attr("d",function(gr){return gr.line}).style("opacity",0).attr("fill","none").attr("stroke","black").attr("stroke-width",2),k(!0)}function x(pr){sa=pr;var yr=I(pr),ur=ye(yr,"in"),hr=ye(yr,"out"),fr=Na(we([pr.sp.x,pr.sp.y],pr.cp_moved,[pr.ep.x,pr.ep.y],ur/2+2)),xr=Na(we([pr.sp.x,pr.sp.y],pr.cp_moved,[pr.ep.x,pr.ep.y],-hr/2-2)),br=Ua.append("g").attr("class","flow_inout"),vr=br.append("path").attr("class","inPath").attr("d",fr).attr("fill","none").attr("stroke","hsl(355, 80%, 50%)").attr("stroke-linecap","butt").attr("stroke-width",ur).on("mouseover",function(){At(pr,!0)}).on("mousemove",Rt).on("mouseout",function(){Me.style("display","none")}),wr=vr.node().getTotalLength(),kr=br.append("path").attr("class","outPath").attr("d",xr).attr("fill","none").attr("stroke","hsl(215, 80%, 50%)").attr("stroke-linecap","butt").attr("stroke-width",hr).on("mouseover",function(){At(pr,!0)}).on("mousemove",Rt).on("mouseout",function(){Me.style("display","none")}),Ar=kr.node().getTotalLength(),Tr=1e3;vr.attr("stroke-dasharray",wr+" "+wr).attr("stroke-dashoffset",wr).transition().duration(Tr).ease(d3.easeSin).attr("stroke-dashoffset",0),kr.attr("stroke-dasharray",Ar+" "+Ar).attr("stroke-dashoffset",-Ar).transition().duration(Tr).ease(d3.easeSin).attr("stroke-dashoffset",0)}function k(pr,yr,ur){void 0===pr&&(pr=!1);var hr=2;Ce.selectAll("path.flow").each(function(mr){var kr,Ar,xr=!1,br=!1,vr=!1,wr=!1;void 0!=yr&&void 0!=ur?(kr=T(mr,yr,ur),Ar=ce(kr)):(kr=I(mr),Ar=pe(kr)),0==kr.balance?0==kr["in"]&&0==kr.out?wr=!0:vr=!0:0>kr.balance?br=!0:0<kr.balance&&(xr=!0);var Tr="#FSel_"+d3.select(this).attr("id").slice(-3);pr?(d3.select(this).attr("stroke-width",Ar).classed("in",xr).classed("out",br).classed("equal",vr),d3.select(Tr).attr("stroke-width",Ar+2*hr)):wr?(d3.select(this).transition().duration(200).style("opacity",0).transition().delay(200).style("visibility","hidden").attr("stroke-width",Ar),d3.select(Tr).transition().delay(200).style("visibility","hidden").attr("stroke-width",Ar+2*hr)):(d3.select(this).classed("in",xr).classed("out",br).classed("equal",vr).transition().duration(200).style("opacity",1).style("visibility","visible").attr("stroke-width",Ar),d3.select(Tr).transition().duration(200).style("visibility","visible").attr("stroke-width",Ar+2*hr))})}function A(){var pr=sa,yr=I(pr),ur=ye(yr,"in"),hr=ye(yr,"out"),fr=Na(we([pr.sp.x,pr.sp.y],pr.cp_moved,[pr.ep.x,pr.ep.y],ur/2+2)),xr=Na(we([pr.sp.x,pr.sp.y],pr.cp_moved,[pr.ep.x,pr.ep.y],-hr/2-2));d3.select(".inPath").attr("stroke-dasharray","").transition().duration(200).attr("d",fr).attr("stroke-width",ur),d3.select(".outPath").attr("stroke-dasharray","").transition().duration(200).attr("d",xr).attr("stroke-width",hr)}function T(pr,yr,ur){for(var hr=0,mr=0,gr=yr;gr<=ur;gr++)hr+=pr["in"][da][gr],mr+=pr.out[da][gr];return{"in":hr,out:mr,balance:hr-mr}}function I(pr){if(na){for(var yr=0,ur=0,hr=0;hr<=Ze;hr++)yr+=pr["in"][da][hr],ur+=pr.out[da][hr];return{"in":yr,out:ur,balance:yr-ur}}return{"in":pr["in"][da][We],out:pr.out[da][We],balance:pr["in"][da][We]-pr.out[da][We]}}function _(pr,yr,ur){var hr={};hr["in"]={job:0,looking:0,study:0,join:0,home:0,other:0},hr.out={job:0,looking:0,study:0,join:0,home:0,other:0},pr.forEach(function(xr){for(var br=0;br<ca.length;br++)for(var vr=yr;vr<=ur;vr++)hr["in"][ca[br]]+=xr["in"][ca[br]][vr],hr.out[ca[br]]+=xr.out[ca[br]][vr],"other"===ca[br]&&(hr["in"][ca[br]]+=xr["in"].no[vr],hr.out[ca[br]]+=xr.out.no[vr])});for(var fr,mr=[],gr=0;gr<ca.length;gr++)fr={},fr.mrom=ca[gr],fr["in"]=hr["in"][ca[gr]],fr.out=hr.out[ca[gr]],mr.push(fr);return mr}function L(pr,yr,ur){var hr={};return hr.mrom="all",hr["in"]=0,hr.out=0,pr.forEach(function(mr){for(var gr=yr;gr<=ur;gr++)hr["in"]+=mr["in"].all[gr],hr.out+=mr.out.all[gr]}),hr}function F(){d3.json(Ha,function(pr,yr){if(pr)throw pr;var ur=topojson.feature(yr,yr.objects[za]);Da.projection(qa),Ua.append("g").attr("class","europe").selectAll("path").data(ur.features).enter().append("path").attr("id",function(mr){return"C_"+mr.properties.ADM0_A3}).attr("class",function(mr){return"GBR"===mr.properties.ADM0_A3?"uk":oa.includes(mr.properties.ADM0_A3)?"eu eu-attime":"non-eu"}).attr("d",Da),Ua.append("path").attr("class","europe-borders").attr("d",Da(topojson.mesh(yr,yr.objects[za],function(mr,gr){return mr!==gr})));var hr=d3.geoGraticule().extent([[-40,81],[80,20]]);Ua.append("path").attr("class","graticule").attr("d",Da(hr())),2===Te?et():3===Te?at():tt()})}function M(){na?d3.selectAll("path.eu").classed("eu-attime",!0).classed("eu-notyet",!1):d3.selectAll("path.eu").each(function(pr){var hr=!1,mr=!1;$e>=ia[pr.properties.ADM0_A3]?hr=!0:mr=!0,d3.select(this).classed("eu-attime",hr).classed("eu-notyet",mr)})}function C(){R(),Q(),Y("visible",2e4),E(),q(),O(),z(),$()}function S(){R(),Q("hidden"),B(),Y("hidden"),E("hidden"),q("hidden"),O("hidden"),z("hidden"),$(),G("hidden"),J("hidden"),N(),V("hidden")}function P(){R(),Q("hidden"),U(),Y("hidden"),E("hidden"),q("hidden"),O("hidden"),z("hidden"),$(),K(),G("hidden"),D(),V("hidden")}function R(){W(),Z()}function O(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0,ur=Le.append("div").attr("id","chart").style("opacity",yr).style("visibility",pr);ur.append("span").html("Main Reasons of Migration");var hr=18,mr=ur.node().getBoundingClientRect(),gr=-90*(Xe/180),fr=90*(Xe/180),xr=90*(Xe/180),br=270*(Xe/180),vr=3,wr=0.02;ha=mr.width,ma=mr.height-hr,ga=28,fa=70,xa=Math.min(ha/2-ga/2-hr,ma/2-ga/2-hr),ua=ur.append("svg").attr("id","svgGraph").attr("width",ha).attr("height",ma),ba=d3.arc().innerRadius(xa+17).outerRadius(xa+38).startAngle(-67*(Xe/180)).endAngle(-47*(Xe/180)).cornerRadius(vr).padAngle(wr),va=d3.arc().innerRadius(xa+17).outerRadius(xa+38).startAngle(113*(Xe/180)).endAngle(133*(Xe/180)).cornerRadius(vr).padAngle(wr),wa=d3.arc().innerRadius(xa+5).outerRadius(xa+5).startAngle(xr).endAngle(br).cornerRadius(vr).padAngle(wr),ka=d3.arc().innerRadius(xa+5).outerRadius(xa+5).startAngle(gr).endAngle(fr).cornerRadius(vr).padAngle(wr),Aa=d3.pie().value(function(Er){return Er.in}).sort(null).startAngle(gr).endAngle(fr),Ta=d3.pie().value(function(Er){return Er.out}).sort(null).startAngle(xr).endAngle(br),Ia=d3.arc().outerRadius(xa).innerRadius(fa).cornerRadius(vr).padAngle(wr),_a=d3.arc().outerRadius(xa).innerRadius(fa).cornerRadius(vr).padAngle(wr),ua.append("g").attr("class","slicesIn"),ua.append("g").attr("class","slicesOut");var kr=ua.append("g");kr.append("path").attr("d",ka).attr("transform","translate("+ha/2+","+(ma/2-ga/2)+")").attr("stroke","hsl(355, 80%, 50%)").attr("fill","none").attr("stroke-width","2"),kr.append("path").attr("d",d3.symbol().type(d3.symbolTriangle).size([24])).attr("transform","translate("+(ha/2-ka.outerRadius()(ka))+", "+(ma/2-ga/2)+") rotate(183)").style("fill","hsl(355, 80%, 50%)");var Ar=ua.append("g");Ar.append("path").attr("d",wa).attr("transform","translate("+ha/2+","+(ma/2+ga/2)+")").attr("stroke","hsl(215, 80%, 50%)").attr("fill","none").attr("stroke-width","2"),Ar.append("path").attr("d",d3.symbol().type(d3.symbolTriangle).size([24])).attr("transform","translate("+(ha/2+wa.outerRadius()(wa))+", "+(ma/2+ga/2)+") rotate(3)").style("fill","hsl(215, 80%, 50%)");var Tr=ua.append("g"),Ir=Tr.append("g").attr("class","widthArrowIn");Ir.append("path").attr("d",d3.line()([[ha/2-wa.outerRadius()(wa)-15,ma/2-ga/2],[ha/2-wa.outerRadius()(wa)-30,ma/2-ga/2]])).attr("stroke","hsl(0, 0%, 75%)").attr("fill","none").attr("stroke-width","1"),Ir.append("path").attr("d",d3.symbol().type(d3.symbolTriangle).size([16])).attr("transform","translate("+(ha/2-wa.outerRadius()(wa)-30)+", "+(ma/2-ga/2)+") rotate(-90)").attr("fill","hsl(0, 0%, 75%)"),Ir.append("path").attr("d",d3.symbol().type(d3.symbolTriangle).size([16])).attr("transform","translate("+(ha/2-wa.outerRadius()(wa)-15)+", "+(ma/2-ga/2)+") rotate(90)").attr("fill","hsl(0, 0%, 75%)"),Ir.attr("transform","rotate(45,"+ha/2+","+(ma/2-ga/2)+")");var _r=Tr.append("g").append("text").attr("id","chartLegendTextIn").attr("transform","translate("+(ha/2-fa-26)+","+(ma/2-wa.outerRadius()(wa)+2)+") rotate(-35)").attr("text-anchor","start").attr("alignment-baseline","middle").attr("fill","hsl(0, 0%, 60%)").text(""),Lr=Tr.append("g");Lr.append("path").attr("d",ba).attr("transform","translate("+ha/2+","+(ma/2-ga/2)+")").attr("stroke","none").attr("fill","hsl(0, 0%, 75%)");var Fr=Tr.append("g").attr("class","widthArrowOut");Fr.append("path").attr("d",d3.line()([[ha/2+wa.outerRadius()(wa)+15,ma/2+ga/2],[ha/2+wa.outerRadius()(wa)+30,ma/2+ga/2]])).attr("stroke","hsl(0, 0%, 75%)").attr("fill","none").attr("stroke-width","1"),Fr.append("path").attr("d",d3.symbol().type(d3.symbolTriangle).size([16])).attr("transform","translate("+(ha/2+wa.outerRadius()(wa)+30)+", "+(ma/2+ga/2)+") rotate(90)").attr("fill","hsl(0, 0%, 75%)"),Fr.append("path").attr("d",d3.symbol().type(d3.symbolTriangle).size([16])).attr("transform","translate("+(ha/2+wa.outerRadius()(wa)+15)+", "+(ma/2+ga/2)+") rotate(-90)").attr("fill","hsl(0, 0%, 75%)"),Fr.attr("transform","rotate(45,"+ha/2+","+(ma/2+ga/2)+")");var Mr=Tr.append("g").append("text").attr("id","chartLegendTextOut").attr("transform","translate("+(ha/2+fa+27)+","+(ma/2+wa.outerRadius()(wa))+") rotate(-35)").attr("text-anchor","end").attr("alignment-baseline","middle").attr("fill","hsl(0, 0%, 60%)").text(""),Cr=Tr.append("g");Cr.append("path").attr("d",va).attr("transform","translate("+ha/2+","+(ma/2+ga/2)+")").attr("stroke","none").attr("fill","hsl(0, 0%, 75%)");for(var Sr=ua.append("g").attr("class","guideLines"),Pr=[0,-45,-90,-135,-180],Rr=0;Rr<Pr.length;Rr++)Sr.append("path").attr("d",d3.line()([[ha/2+fa-8,ma/2-ga/2],[ha/2+fa-2,ma/2-ga/2]])).attr("transform","rotate("+Pr[Rr]+","+ha/2+","+(ma/2-ga/2)+")").attr("stroke","hsl(0, 0%, 60%)").attr("fill","none").attr("stroke-width","0.5");for(var Pr=[0,45,90,135,180],Rr=0;Rr<Pr.length;Rr++)Sr.append("path").attr("d",d3.line()([[ha/2+fa-8,ma/2+ga/2],[ha/2+fa-2,ma/2+ga/2]])).attr("transform","rotate("+Pr[Rr]+","+ha/2+","+(ma/2+ga/2)+")").attr("stroke","hsl(0, 0%, 60%)").attr("fill","none").attr("stroke-width","0.5");ua.append("text").attr("transform","translate("+(ha/2-xa)+","+ma/2+")").attr("text-anchor","middle").attr("alignment-baseline","middle").text("United Kingdom"),ua.append("text").attr("id","countryOriginLabel").attr("transform","translate("+(ha/2+xa)+","+ma/2+")").attr("text-anchor","middle").attr("alignment-baseline","middle").text("EU 27"),ua.append("text").attr("id","chartYearLabel").attr("transform","translate("+ha/2+","+ma/2+")").attr("text-anchor","middle").attr("alignment-baseline","middle").text("2000 - 2016");var Or=ua.append("text").attr("transform","translate("+ha/2+","+(ma/2-45)+")").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("id","txtLegendJob").style("font-weight","normal").text("definite job");ve(ua,Or.node(),"reasonsLegend",ya.job["in"]),ua.append("use").attr("xlink:href","#txtLegendJob"),Or=ua.append("text").attr("transform","translate("+ha/2+","+(ma/2-25)+")").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("id","txtLegendLooking").style("font-weight","normal").text("looking for work"),ve(ua,Or.node(),"reasonsLegend",ya.looking["in"]),ua.append("use").attr("xlink:href","#txtLegendLooking"),Or=ua.append("text").attr("transform","translate("+ha/2+","+(ma/2+25)+")").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("id","txtLegendStudy").style("font-weight","normal").text("studying"),ve(ua,Or.node(),"reasonsLegend",ya.study["in"]),ua.append("use").attr("xlink:href","#txtLegendStudy"),Or=ua.append("text").attr("transform","translate("+ha/2+","+(ma/2+45)+")").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("id","txtLegendJoin").style("font-weight","normal").text("joining someone"),ve(ua,Or.node(),"reasonsLegend",ya.join["in"]),ua.append("use").attr("xlink:href","#txtLegendJoin")}function E(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0;Le.append("button").attr("id","toggleHowTo").html("Hide hints").style("opacity",yr).style("visibility",pr).on("click",Kt)}function Y(pr,yr){pr=ge(pr,["visible","hidden"]);var ur="visible"===pr?1:0;lr="visible"===pr,ar=Le.append("svg").attr("id","hintsCondition1").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").style("opacity",ur).style("visibility",pr),ar.append("image").attr("xlink:href",or).attr("width",20).attr("height",20).attr("transform","translate(25 100) rotate(-70)");var hr=ar.append("text").attr("transform","translate(55 110) rotate(-2)").text("click to show or hide hints");be(ar,hr.node(),"hint1","yellow"),ar.append("image").attr("xlink:href",or).attr("width",20).attr("height",20).attr("transform","scale(-1 1) translate(-15 585) rotate(120)"),hr=ar.append("text").attr("id","hintToggleMode").attr("transform","translate(40 580) rotate(-2)").text("click to investigate by years or combine all years"),be(ar,hr.node(),"hint1","yellow"),ar.append("image").attr("xlink:href",or).attr("width",20).attr("height",20).attr("transform","scale(-1 1) translate(-140 215) rotate(180)"),hr=ar.append("text").attr("id","hintToggleMode").attr("transform","translate(10 185) rotate(-2)").text("mouseover countries or flow lines"),be(ar,hr.node(),"hint1","yellow"),ar.append("image").attr("xlink:href",or).attr("width",20).attr("height",20).attr("transform","scale(-1 1) translate(-575 375) rotate(-20)"),hr=ar.append("text").attr("id","hintToggleMode").attr("transform","translate(520 420) rotate(-2)").text("click on countries or flow lines"),be(ar,hr.node(),"hint1","yellow"),ar.append("image").attr("xlink:href",or).attr("width",20).attr("height",20).attr("transform","scale(-1 1) translate(-855 605) rotate(90)"),hr=ar.append("text").attr("transform","translate(885 610) rotate(-2)").text("time remaining"),be(ar,hr.node(),"hint1","yellow"),void 0===yr||isNaN(yr)||ar.transition().delay(yr).duration(500).style("opacity",0).on("end",function(){ar.style("visibility","hidden"),lr=!1,d3.select("#toggleHowTo").html("Show hints")})}function B(){rr=Le.append("svg").attr("id","hintsCondition2").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%"),rr.append("image").attr("xlink:href",or).attr("class","hint2").attr("width",20).attr("height",20).attr("transform","scale(-1 1) translate(-855 605) rotate(90)");var pr=rr.append("text").attr("transform","translate(885 610) rotate(-2)").attr("class","hint2").text("time remaining");be(rr,pr.node(),"hint2","purple"),fe({selector:".hint2",delay:2e4,duration:500,opacity:0}),rr.append("image").attr("xlink:href",or).attr("class","hint2b").attr("width",20).attr("height",20).attr("transform","translate(600 290) rotate(-95)"),pr=rr.append("text").attr("transform","translate(630 290) rotate(-2)").attr("class","hint2b").text("Use the arrow buttons to explore more."),be(rr,pr.node(),"hint2b","purple"),pr=rr.append("text").attr("transform","translate(635 320) rotate(-2)").attr("class","hint2b").text("Read the texts and answer the questions."),be(rr,pr.node(),"hint2b","purple"),pr=rr.append("text").attr("transform","translate(640 350) rotate(-2)").attr("class","hint2b").text("A progress bar will show you how far you are."),be(rr,pr.node(),"hint2b","purple")}function U(){nr=Le.append("svg").attr("id","hintsCondition3").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%"),nr.append("image").attr("xlink:href",or).attr("class","hint3").attr("width",20).attr("height",20).attr("transform","scale(-1 1) translate(-855 605) rotate(90)");var pr=nr.append("text").attr("transform","translate(885 610) rotate(-2)").attr("class","hint3").text("time remaining");be(nr,pr.node(),"hint3","purple"),fe({selector:".hint3",delay:4e4,duration:500,opacity:0}),nr.append("image").attr("xlink:href",or).attr("class","hint3b").attr("width",20).attr("height",20).attr("transform","scale(-1 1) translate(-735 190) rotate(-85)"),pr=nr.append("text").attr("transform","translate(525 200) rotate(-2)").attr("class","hint3b").text("Select one story at a time"),be(nr,pr.node(),"hint3b","purple"),pr=nr.append("text").attr("transform","translate(570 230) rotate(-2)").attr("class","hint3b").text("and see what each of us has to tell you."),be(nr,pr.node(),"hint3b","purple"),pr=nr.append("text").attr("transform","translate(620 260) rotate(-2)").attr("class","hint3b").text("Read the texts and follow the animation carefully."),be(nr,pr.node(),"hint3b","purple")}function D(){var pr=Le.append("div").attr("id","journeySelection"),yr=["cecile","klaus","jakub","alejandro","francesca","ileana"];for(let hr=0;hr<yr.length;hr++){var ur=pr.append("div").data([yr[hr]]).attr("class","storyButton").attr("id","storyButton-"+yr[hr]).on("click",function(mr){Xt(mr)}).on("mousemove",function(mr){Wt(mr)}).on("mouseout",function(mr){Zt(mr)});ur.append("svg").attr("width",storyScript[yr[hr]].selectIcon.w).attr("height",storyScript[yr[hr]].selectIcon.h).attr("viewBox","0 0 "+storyScript[yr[hr]].selectIcon.w+" "+storyScript[yr[hr]].selectIcon.h).append("image").attr("id","select-image-"+yr[hr]).attr("href",ir[yr[hr]]).attr("xlink:href",ir[yr[hr]]).attr("height",storyScript[yr[hr]].selectIcon.h).attr("width",storyScript[yr[hr]].selectIcon.w),ur.append("p").html(storyScript[yr[hr]].displayName)}}function z(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0,ur=Le.append("div").attr("id","legend").style("opacity",yr).style("visibility",pr);ur.append("span").attr("id","flowTypeLegend").attr("class","legendHeader").html("Net UK Migration Flows"),ur.append("svg").attr("id","svgLegend").attr("width","100%"),ur.append("span").attr("id","flowTypeLegend").attr("class","legendHeader").html("EU Membership");var hr=ur.append("div").attr("class","legend1");hr.append("div").attr("class","legend1").append("p").attr("class","country-name").html("<span class='key-dot member'></span>Member"),hr.append("div").attr("class","legend1").append("p").attr("class","country-name").html("<span class='key-dot candidate'></span>Candidate"),hr.append("div").attr("class","legend1").append("p").attr("class","country-name").html("<span class='key-dot noneu'></span>Non EU")}function q(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0;Le.append("div").attr("id","slider").style("opacity",yr).style("visibility",pr),Fe=document.getElementById("slider"),noUiSlider.create(Fe,{start:Qe,step:1,tooltips:!0,format:{to:function(ur){return ur},from:function(ur){return ur}},range:{min:Qe,max:ta}}),Fe.style.opacity="0.3",Fe.setAttribute("disabled",!0)}function N(){var pr=Ee.append("div").attr("id","storyNavigation");pr.append("div").attr("id","navigateUp").attr("class","navButton").html("<div>&#9668;</div>"),pr.append("div").attr("id","chapterProgress"),pr.append("div").attr("id","navigateDown").attr("class","navButton").html("<div>&#9658;</div>")}function K(){var pr=Le.append("div").attr("id","storyFocusMask").style("visibility","hidden").append("svg"),yr=pr.append("defs").append("mask").attr("id","svgStoryFocusMask");yr.append("rect").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").style("fill","white"),yr.append("ellipse").attr("rx",100).attr("ry",100);var ur=pr.attr("class","storyFocus").attr("width","100%").attr("height","100%").append("g").attr("transform","translate(0,0)"),hr=ur.append("rect").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("mask","url(#svgStoryFocusMask)").style("fill","gray").style("opacity",0.7)}function V(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0,ur=Le.append("div").attr("class","infoModal").style("opacity",yr).style("visibility",pr),hr=ur.append("div").attr("class","infoModalContent");hr.append("div").attr("class","infoModalText").html("Well done!<br><br>Do not worry if you did not see everything. You have <b>3 minutes</b> now to investigate the data for all EU member states.<br><br>Click OK when you are ready to continue."),hr.append("div").attr("class","okButtonDiv").append("button").attr("class","okButton").html("OK").on("click",function(){o("V"),Ne.restart(function(mr){Nt(mr)}),ur.transition().duration(800).style("opacity",0).style("visibility","hidden").remove(),fe({selector:"#hintsCondition1",delay:2e4,duration:500,opacity:0}),sr=d3.timeout(function(){d3.select("#toggleHowTo").html("Show hints"),lr=!1},2e4)})}function G(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0;Oe=Le.append("div").attr("id","storyText").style("opacity",yr).style("visibility",pr)}function J(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0;Ee=Le.append("div").attr("id","storyTextC2").style("opacity",yr).style("visibility",pr),Ee.append("div").attr("id","storyTextC2Text")}function W(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0;Pe=Le.append("span").attr("id","numericTimer").attr("class","green").style("opacity",yr).style("visibility",pr).text("about 5 minutes left")}function Z(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0;Le.append("div").attr("id","title").style("opacity",yr).style("visibility",pr).html("Migration of EU Citizens from and to the UK <span id='yearTitle'>2000 - 2016</span>")}function Q(pr){pr=ge(pr,["visible","hidden"]);var yr="visible"===pr?1:0;Le.append("button").attr("id","toggleMode").html("Show by years").style("opacity",yr).style("visibility",pr).on("click",Vt)}function $(){Me=Le.append("div").attr("class","tooltip").style("display","none")}function tt(){g(),nt(),lt(flowData,0,Ze,!1),rt(),_t(!0),Tt(!0)}function et(){g("hidden"),nt(),lt(flowData,0,Ze,!1),rt(),Ft(!0),storyScript.chapters[0].forEach(function(pr){d3.select(pr.args.selector).transition(),window.Flowstory[pr.func](pr.args)})}function at(){g("hidden"),nt(),lt(flowData,0,Ze,!1),rt()}function rt(){var pr=d3.select("#svgLegend"),yr=pr.append("g").attr("id","legendOverallMode"),ur=pr.append("g").attr("id","legendDetailMode").style("visibility","hidden");ur.append("text").attr("transform","translate(0, 16)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").style("fill","hsl(355, 80%, 50%)").text("citizens entering the UK"),ur.append("text").attr("transform","translate(0, 133)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").style("fill","hsl(215, 80%, 50%)").text("citizens leaving the UK"),ur.append("text").attr("id","maxLegendDetailTxt").attr("transform","translate(100, 53)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").text(Je(Ea)+" or more"),ur.append("text").attr("id","midLegendDetailTxt").attr("transform","translate(100, 95)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").text(Ge(Math.abs(Ea-ja)/2)),ur.append("text").attr("id","minLegendDetailTxt").attr("transform","translate(100, 116)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").text(Je(ja)+" or less");var hr=30,mr=(aa-ea)*(Math.abs(Ea)-Fa)/(La-Fa)+ea;ur.append("rect").attr("id","detailLegendMaxRectIn").attr("x",0).attr("y",hr).attr("width",45).attr("height",mr).style("fill","hsl(355, 80%, 50%)"),ur.append("rect").attr("id","detailLegendMaxRectOut").attr("x",45).attr("y",hr).attr("width",45).attr("height",mr).style("fill","hsl(215, 80%, 50%)"),hr+=mr+10,mr=(aa-ea)*(Math.abs(Ea-ja)/2-Fa)/(La-Fa)+ea,ur.append("rect").attr("id","detailLegendMidRectIn").attr("x",0).attr("y",hr).attr("width",45).attr("height",mr).style("fill","hsl(355, 80%, 50%)"),ur.append("rect").attr("id","detailLegendMidRectOut").attr("x",45).attr("y",hr).attr("width",45).attr("height",mr).style("fill","hsl(215, 80%, 50%)"),hr+=mr+10,mr=(aa-ea)*(Math.abs(ja)-Fa)/(La-Fa)+ea,ur.append("rect").attr("id","detailLegendMinRectIn").attr("x",0).attr("y",hr).attr("width",45).attr("height",mr).style("fill","hsl(355, 80%, 50%)"),ur.append("rect").attr("id","detailLegendMinRectOut").attr("x",45).attr("y",hr).attr("width",45).attr("height",mr).style("fill","hsl(215, 80%, 50%)"),yr.append("text").attr("transform","translate(0, 16)").attr("text-anchor","start").style("font-size","small").style("fill","hsl(355, 80%, 50%)").attr("alignment-baseline","middle").text("more citizens entering than leaving"),yr.append("text").attr("transform","translate(0, 115)").attr("text-anchor","start").style("font-size","small").style("fill","hsl(215, 80%, 50%)").attr("alignment-baseline","middle").text("more citizens leaving than entering"),yr.append("text").attr("id","maxLegendOverallTxt").attr("transform","translate(100, 47)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").text(Je(La)+" or more"),yr.append("text").attr("id","midLegendOverallTxt").attr("transform","translate(100, 79)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").text(Ge((La-Fa)/2)),yr.append("text").attr("id","minLegendOverallTxt").attr("transform","translate(100, 96)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").text(Je(Fa)+" or less"),yr.append("text").attr("transform","translate(100, 137)").attr("text-anchor","start").style("font-size","small").attr("alignment-baseline","middle").text("inflow = outflow");var hr=30,mr=aa;yr.append("rect").attr("x",0).attr("y",hr).attr("width",45).attr("height",mr).style("fill-opacity",0.6).style("fill","hsl(355, 80%, 50%)"),yr.append("rect").attr("x",45).attr("y",hr).attr("width",45).attr("height",mr).style("fill-opacity",0.6).style("fill","hsl(215, 80%, 50%)"),hr+=mr+10,mr=(aa-ea)/2,yr.append("rect").attr("x",0).attr("y",hr).attr("width",45).attr("height",mr).style("fill-opacity",0.6).style("fill","hsl(355, 80%, 50%)"),yr.append("rect").attr("x",45).attr("y",hr).attr("width",45).attr("height",mr).style("fill-opacity",0.6).style("fill","hsl(215, 80%, 50%)"),hr+=mr+10,mr=ea,yr.append("rect").attr("x",0).attr("y",hr).attr("width",45).attr("height",mr).style("fill-opacity",0.6).style("fill","hsl(355, 80%, 50%)"),yr.append("rect").attr("x",45).attr("y",hr).attr("width",45).attr("height",mr).style("fill-opacity",0.6).style("fill","hsl(215, 80%, 50%)"),yr.append("rect").attr("x",0).attr("y",136).attr("width",90).attr("height",ea).style("fill-opacity",0.6).style("fill","hsl(55, 90%, 45%)")}function nt(){Fe.noUiSlider.on("update",function(pr,yr){it(pr,yr)})}function lt(pr,yr,ur,hr){var mr=_(pr,yr,ur),gr=L(pr,yr,ur),fr=Math.max(gr.in,gr.out),xr=(xa-fa)*gr.in/fr+fa,br=(xa-fa)*gr.out/fr+fa;Ia.outerRadius(xr),_a.outerRadius(br);var vr=ua.select(".slicesIn").selectAll("path.slice").data(Aa(mr),function(Cr){return Cr.data.mrom}).attr("transform","translate("+ha/2+","+(ma/2-ga/2)+")");vr.enter().insert("path").style("fill",function(Cr){return ya[Cr.data.mrom]["in"]}).attr("class","slice").attr("transform","translate("+ha/2+","+(ma/2-ga/2)+")").attr("d",Ia),hr?vr.transition().duration(200).attrTween("d",function(Cr){this._current=this._current||Cr;var Sr=d3.interpolate(this._current,Cr);return this._current=Sr(0),function(Pr){return Ia(Sr(Pr))}}):vr.attr("d",Ia),vr.exit().remove();var wr=ua.select(".slicesOut").selectAll("path.slice").data(Ta(mr),function(Cr){return Cr.data.mrom}).attr("transform","translate("+ha/2+","+(ma/2+ga/2)+")");wr.enter().insert("path").style("fill",function(Cr){return ya[Cr.data.mrom]["in"]}).attr("class","slice").attr("transform","translate("+ha/2+","+(ma/2+ga/2)+")").attr("d",_a),hr?wr.transition().duration(200).attrTween("d",function(Cr){this._current=this._current||Cr;var Sr=d3.interpolate(this._current,Cr);return this._current=Sr(0),function(Pr){return _a(Sr(Pr))}}):wr.attr("d",_a),wr.exit().remove();var Ar,kr=ua.select("#countryOriginLabel");kr.node()&&(Ar=kr.text()),1<pr.length?kr.text("EU 27"):kr.text(pr[0].c),kr.node()&&Ar!=kr.text()&&xe(ua,kr.node(),"txtCountryOrigin");var Ir,Tr=ua.select("#chartYearLabel");Tr.node()&&(Ir=Tr.text()),yr==ur?Tr.text($e):Tr.text(Qe+" - "+ta),Tr.node()&&Ir!=Tr.text()&&xe(ua,Tr.node(),"txtYear");var Lr,_r=d3.select("#chartLegendTextIn");_r.node()&&(Lr=_r.text(),_r.text(Ge(gr.in)),Lr!=_r.text()&&xe(ua,_r.node(),"txtLegendValIn"));var Mr,Fr=d3.select("#chartLegendTextOut");Fr.node()&&(Mr=Fr.text(),Fr.text(Ge(gr.out)),Mr!=Fr.text()&&xe(ua,Fr.node(),"txtLegendValOut"))}function st(){var pr=d3.select("#legendOverallMode"),yr=d3.select("#legendDetailMode");if(la){pr.style("visibility","hidden"),yr.style("visibility","visible"),d3.select("#flowTypeLegend").text("IN and OUT Flows "+(na?Qe+" - "+ta:$e));var ur=d3.select("#maxLegendDetailTxt"),hr=ur.text();ur.text(Je(na?Ea:Sa)+" or more");var mr=d3.select("#midLegendDetailTxt"),gr=mr.text();mr.text(Ge(na?(Ea-ja)/2:(Sa-Pa)/2));var fr=d3.select("#minLegendDetailTxt"),xr=fr.text();fr.text(Je(na?ja:Pa)+" or less"),hr!=ur.text()&&xe(yr,ur.node(),"maxLT"),gr!=mr.text()&&xe(yr,mr.node(),"midLT"),xr!=fr.text()&&xe(yr,fr.node(),"minLT");var br=na?30:33,vr=(aa-ea)*(Math.abs(na?Ea:Sa)-Fa)/(La-Fa)+ea;d3.selectAll("#detailLegendMaxRectIn, #detailLegendMaxRectOut").attr("y",br).attr("height",vr),br+=vr+(na?10:16),vr=(aa-ea)*(Math.abs(na?(Ea-ja)/2:(Sa-Pa)/2)-Fa)/(La-Fa)+ea,d3.selectAll("#detailLegendMidRectIn, #detailLegendMidRectOut").attr("y",br).attr("height",vr),br+=vr+(na?10:13),vr=(aa-ea)*(Math.abs(na?ja:Pa)-Fa)/(La-Fa)+ea,d3.selectAll("#detailLegendMinRectIn, #detailLegendMinRectOut").attr("y",br).attr("height",vr)}else{yr.style("visibility","hidden"),pr.style("visibility","visible"),d3.select("#flowTypeLegend").html("Net UK Migration Flows");var ur=d3.select("#maxLegendOverallTxt"),hr=ur.text();ur.text(Je(La)+" or more");var mr=d3.select("#midLegendOverallTxt"),gr=mr.text();mr.text(Ge((La-Fa)/2));var fr=d3.select("#minLegendOverallTxt"),xr=fr.text();fr.text(Je(Fa)+" or less"),hr!=ur.text()&&xe(pr,ur.node(),"maxLT"),gr!=mr.text()&&xe(pr,mr.node(),"midLT"),xr!=fr.text()&&xe(pr,fr.node(),"minLT")}}function it(pr){We=+(pr[0]+"").substr(2),$e=+pr[0],o("D"+We),kt(),M(),k(),la?(A(),lt([sa],We,We,!0),st()):lt(flowData,We,We,!0)}function dt(pr){var yr=d3.select("#svgStoryFocusMask>ellipse");yr.attr("rx",pr.rx).attr("ry",pr.ry).attr("transform","translate("+pr.tx+","+pr.ty+") rotate("+pr.r+")")}function pt(pr){var yr=pr.duration/2;Oe.transition().delay(pr.delay).duration(yr).style("visibility","visible").style("opacity",0).on("end",function(){Oe.html("texts"in storyScript&&pr.storyText in storyScript.texts?storyScript.texts[pr.storyText]:pr.storyText)}).transition().duration(yr).style("visibility","visible").style("opacity",1)}function yt(pr){Oe.style("opacity",0).html("texts"in storyScript&&pr.storyText in storyScript.texts?storyScript.texts[pr.storyText]:pr.storyText).transition().delay(pr.delay).duration(pr.duration).style("visibility","visible").style("opacity",1)}function ut(pr){Oe.style("opacity",0).style("top",void 0==pr.style.top?Oe.style("top"):pr.style.top).style("left",void 0==pr.style.left?Oe.style("left"):pr.style.left).style("width",void 0==pr.style.width?Oe.style("width"):pr.style.width).style("border",void 0==pr.style.border?Oe.style("border"):pr.style.border).html("texts"in storyScript&&pr.storyText in storyScript.texts?storyScript.texts[pr.storyText]:pr.storyText).transition().delay(pr.delay).duration(pr.duration).style("visibility","visible").style("opacity",1)}function ht(pr){var yr=pr.duration/2;Oe.transition().delay(pr.delay).duration(yr).style("visibility","visible").style("opacity",0).on("end",function(){Oe.style("top",void 0==pr.style.top?Oe.style("top"):pr.style.top).style("left",void 0==pr.style.left?Oe.style("left"):pr.style.left).style("width",void 0==pr.style.width?Oe.style("width"):pr.style.width).style("border",void 0==pr.style.border?Oe.style("border"):pr.style.border).html("texts"in storyScript&&pr.storyText in storyScript.texts?storyScript.texts[pr.storyText]:pr.storyText)}).transition().duration(yr).style("visibility","visible").style("opacity",1)}function mt(pr){for(var yr=Ee.select(pr.selector),ur=pr.fromYearIdx;ur<=pr.toYearIdx;ur++)yr.append("button").attr("class","yearButton").html(2e3+ur).data([ur]).style("background-color",ur==pr.startIdx?"#999":"#eee").on("click",function(hr){yr.selectAll("button").style("background-color","#eee"),d3.select(this).style("background-color","#999"),cr.updateInOutFlowForSelectionByYears({selector:[pr.cc],id:pr.id,delay:0,duration:1e3,opacity:1,fromYearIdx:hr,toYearIdx:hr}),o("K"+hr)})}function gt(pr){var yr=pr.duration/2;Ee.style("visibility","visible").style("opacity",1),d3.select("#storyTextC2Text").transition().delay(pr.delay).duration(yr).style("visibility","visible").style("opacity",0).on("end",function(){Ee.style("top",void 0==pr.style.top?Ee.style("top"):pr.style.top).style("left",void 0==pr.style.left?Ee.style("left"):pr.style.left).style("width",void 0==pr.style.width?Ee.style("width"):pr.style.width).select("#storyTextC2Text").html("texts"in storyScript&&pr.storyText in storyScript.texts?storyScript.texts[pr.storyText]:pr.storyText),1===qe?(document.getElementById("yearInflow").value=void 0==Ye.yearInflow?document.getElementById("yearInflow").value:Ye.yearInflow,document.getElementById("yearOutflow").value=void 0==Ye.yearOutflow?document.getElementById("yearOutflow").value:Ye.yearOutflow,mt({fromYearIdx:4,toYearIdx:10,cc:"POL",id:"inOutFlowPoland",startIdx:5,selector:"#yearSelectorPoland"})):3===qe?void 0!=Ye.roubgr&&(d3.select("input[value=\""+Ye.roubgr+"\"]").node().checked=!0):5===qe?void 0!=Ye.oldeu&&(d3.select("input[value=\""+Ye.oldeu+"\"]").node().checked=!0):7===qe?void 0!=Ye.netflows&&(d3.select("input[value=\""+Ye.netflows+"\"]").node().checked=!0):2===qe?(d3.select("#aPoland").html(Ye.yearInflow+" and "+Ye.yearOutflow),mt({fromYearIdx:7,toYearIdx:8,cc:"POL",id:"inOutFlowPoland",startIdx:7,selector:"#yearSelectorPoland"})):4===qe?d3.select("#aRouBgr").html(Ye.roubgr):6===qe?d3.select("#aOldEu").html(Ye.oldeu):8==qe&&d3.select("#aNetFlows").html(Ye.netflows),ft(),Gt()}).transition().duration(yr).style("visibility","visible").style("opacity",1)}function ft(){qe===ze?(d3.selectAll("#navigateDown").style("opacity",1).style("visibility","visible"),d3.selectAll("#navigateUp, #chapterProgress").style("opacity",0).style("visibility","hidden")):qe===He?(d3.selectAll("#navigateUp, #chapterProgress").style("opacity",1).style("visibility","visible"),d3.selectAll("#navigateDown").style("opacity",0).style("visibility","hidden")):d3.selectAll("#navigateDown, #navigateUp, #chapterProgress").style("opacity",1).style("visibility","visible")}function xt(pr){for(var yr in pr)Oe.style(yr+"",pr[yr]+"px")}function bt(pr){for(var yr in pr)Oe.style(yr+"",pr[yr])}function wt(pr){var mr,yr=Math.ceil(pr/1e3),ur=Math.ceil(yr/60),hr=Pe.text();30>=yr?(mr=1==yr?yr+" second left":yr+" seconds left",hr!=mr&&Pe.attr("class","red").text(mr)):1>=ur?(mr="about "+ur+" minute left",hr!=mr&&Pe.attr("class","orange").text(mr).style("background-color","rgba(255, 255, 0, 0.5)").transition().duration(750).ease(d3.easeExp).style("background-color","rgba(255, 255, 0, 0)")):(mr="about "+ur+" minutes left",hr!=mr&&Pe.attr("class","green").text(mr).style("background-color","rgba(255, 255, 0, 0.5)").transition().duration(750).ease(d3.easeExp).style("background-color","rgba(255, 255, 0, 0)"))}function kt(){d3.select("#yearTitle").text(na?Qe+" - "+ta:$e).style("background-color","rgba(255, 255, 0, 0.5)").transition().duration(750).ease(d3.easeExp).style("background-color","rgba(255, 255, 0, 0)")}function At(pr,yr){void 0===yr&&(yr=!1);var ur=na?pr.sum_all_in:pr["in"][da][We],hr=na?pr.sum_all_out:pr.out[da][We],mr=ur-hr,gr="txtEqual";0<mr?gr="txtIn":0>mr&&(gr="txtOut"),Me.style("display","inline").html(la?yr?"<span class='txtIn'><b>"+pr.c+"</b> &rarr; UK: <b>"+Ge(ur)+"</b></span><br /><span class='txtOut'>UK &rarr; <b>"+pr.c+"</b>: <b>"+Ge(hr)+"</b></span><hr /><span class='"+gr+"'>Net Flow: "+Ge(Math.abs(ur-hr))+"</span>":"Click to see the in and out flow for <b>"+pr.c+"</b>":"<b>"+pr.c+"</b> &rarr; UK: <b>"+Ge(ur)+"</b><br />UK &rarr; <b>"+pr.c+"</b>: <b>"+Ge(hr)+"</b><hr /><b class='"+gr+"'>Net Flow: "+Ge(Math.abs(ur-hr))+"</b>")}function Tt(pr){d3.selectAll(".flowSel").on("click",pr?function(yr){St(yr)}:null).on("mouseover",pr?function(yr){Bt(yr)}:null).on("mousemove",pr?function(){Rt()}:null).on("mouseout",pr?function(yr){Et(yr)}:null),d3.selectAll("path.eu").on("click",pr?function(yr){Ct(yr)}:null).on("mouseover",pr?function(yr){Yt(yr)}:null).on("mousemove",pr?function(){Rt()}:null).on("mouseout",pr?function(yr){Ot(yr)}:null)}function It(){return this==d3.event.target}function _t(pr){d3.select("body").on("mousedown",pr?function(){var yr=d3.selectAll(".eu, .flowSel, .inPath, .outPath, #toggleMode, #toggleHowTo, .noUi-base, .noUi-handle, .noUi-tooltip").filter(It).empty();yr&&Mt()}:null)}function Lt(){if(1===qe){if(""===d3.select("#yearInflow").node().value||""===d3.select("#yearOutflow").node().value)return!1;Ye.yearInflow=d3.select("#yearInflow").node().value,Ye.yearOutflow=d3.select("#yearOutflow").node().value,o("L"+Ye.yearInflow+Ye.yearOutflow)}else if(3===qe){if(d3.select("input[name=\"roubgr\"]:checked").empty())return!1;Ye.roubgr=d3.select("input[name=\"roubgr\"]:checked").node().value,o("L"+Ye.roubgr.charAt(0).toUpperCase())}else if(5===qe){if(d3.select("input[name=\"oldeu\"]:checked").empty())return!1;Ye.oldeu=d3.select("input[name=\"oldeu\"]:checked").node().value,o("L"+Ye.oldeu.charAt(0).toUpperCase())}else if(7===qe){if(d3.select("input[name=\"netflows\"]:checked").empty())return!1;Ye.netflows=d3.select("input[name=\"netflows\"]:checked").node().value,o("L"+Ye.netflows.charAt(0).toUpperCase())}return!0}function Ft(pr){d3.select("#navigateDown").on("click",pr?function(){Lt()?Jt(1):(d3.select(".qStory").interrupt().transition(),d3.select(".qStory").style("background-color","rgba(128, 0, 128, 0.4)").transition().duration(3e3).ease(d3.easeExp).style("background-color","rgba(128, 0, 128, 0)"))}:null),d3.select("#navigateUp").on("click",pr?function(){Jt(-1)}:null)}function Mt(){o("G"),Ce.selectAll(".flow").classed("unfocus",!1).classed("selected",!1).classed("mouseover",!1),d3.selectAll(".eu").classed("selected",!1).classed("mouseover",!1),Me.style("display","none"),d3.selectAll("g.flow_inout").transition().duration(500).style("opacity",0).remove(),la=!1,sa=void 0,lt(flowData,na?0:We,na?Ze:We,!1),st()}function Ct(pr){o("FC"+pr.properties.ADM0_A3),Pt(Ce.select("#F_"+pr.properties.ADM0_A3).data()[0],pr.properties.ADM0_A3)}function St(pr){o("FF"+pr.cc),Pt(pr,pr.cc)}function Pt(pr,yr){Ce.selectAll(".flow").classed("unfocus",!1),d3.selectAll(".eu").classed("selected",!1),d3.selectAll("g.flow_inout").remove(),d3.select("#C_"+yr).classed("selected",!0),Ce.select("#F_"+yr).classed("selected",!0),Ce.selectAll(".flow").classed("unfocus",!0),x(pr),la=!0,lt([pr],na?0:We,na?Ze:We,!1),At(pr,!0),st()}function Rt(){var pr=Le.node().getBoundingClientRect();Me.style("left",d3.event.pageX-(pr.left+window.scrollX)+8+"px").style("top",d3.event.pageY-(pr.top+window.scrollY)+8+"px")}function Ot(pr){jt(pr.properties.ADM0_A3)}function Et(pr){jt(pr.cc)}function jt(pr){la&&Ce.select("#F_"+pr).classed("unfocus",!0),d3.select("#C_"+pr).classed("mouseover",!1),Ce.select("#F_"+pr).classed("mouseover",!1),Me.style("display","none"),la||lt(flowData,na?0:We,na?Ze:We,!1)}function Yt(pr){o("EC"+pr.properties.ADM0_A3),Ut(Ce.select("#F_"+pr.properties.ADM0_A3).data()[0],pr.properties.ADM0_A3)}function Bt(pr){o("EF"+pr.cc),Ut(pr,pr.cc)}function Ut(pr,yr){var ur=d3.select("#C_"+yr).classed("selected");d3.select("#C_"+yr).classed("mouseover",!0),la?!ur&&Ce.select("#F_"+yr).classed("unfocus",!1):Ce.select("#F_"+yr).classed("mouseover",!0),At(pr,ur),la||lt([pr],na?0:We,na?Ze:We,!1)}function Dt(){o("Z");var pr=0;fe({selector:"#hintsCondition3",delay:pr,duration:500,opacity:0}),d3.selectAll(".storyButton").classed("transition",!0).on("click",null).on("mousemove",null).on("mouseout",null),pr+=1e3,xt({top:250,left:600}),bt({border:"1px solid #333"}),yt({delay:pr,duration:500,storyText:"Between 2000 and 2016 Cecile, Klaus, Susanne, Jakub, Alejandro, Francesca and Ileana migrated to or from the UK for various reasons."}),zt(pr+20),Ht(pr+30),pr+=9e3,pt({delay:pr,duration:1e3,storyText:"Not only them, but also many other French, German, Spanish, Italian, Polish, Polish and Romanian citizens moved to or from the UK during this period."}),pr+=2e3;for(var yr=[{name:"cecile",cc:"FRA",da:200},{name:"klaus",cc:"DEU",da:200},{name:"jakub",cc:"POL",da:200},{name:"alejandro",cc:"ESP",da:200},{name:"francesca",cc:"ITA",da:200},{name:"ileana",cc:"ROU",da:200}],ur=0;ur<yr.length;ur++){var hr=d3.select("#F_"+yr[ur].cc).data()[0],mr=d3.select("#F_"+yr[ur].cc).node().getTotalLength(),gr={balance:hr.sum_all_in-hr.sum_all_out,"in":hr.sum_all_in,out:hr.sum_all_out};d3.select("#journey-path-final-"+yr[ur].name).transition().delay(pr).duration(2e3).attr("d",hr.line).attr("stroke-width",pe(gr)).attr("stroke","hsl(355, 80%, 50%)").style("stroke-opacity",0.6).attr("stroke-dasharray",mr).attr("stroke-dashoffset",0)}pr+=8e3,pt({delay:pr,duration:1e3,storyText:"In fact, many citizens of other countries of the European Union came or left between 2000 and 2016."}),pr+=2e3,fe({selector:".flow_group",delay:pr,duration:2e3,opacity:1}),pr+=500,fe({selector:"#stories-final",delay:pr,duration:1e3,opacity:0}),pr+=5e3,fe({selector:"#storyText",delay:pr,duration:2e3,opacity:0}),pr+=1e3,fe({selector:".infoModal",delay:pr,duration:800,opacity:1}),fe({selector:"#slider",delay:pr,duration:2e3,opacity:0.3}),fe({selector:"#chart",delay:pr,duration:2e3,opacity:1}),fe({selector:"#legend",delay:pr,duration:2e3,opacity:1}),fe({selector:"#toggleMode",delay:pr,duration:2e3,opacity:1}),fe({selector:"#toggleHowTo",delay:pr,duration:2e3,opacity:1}),fe({selector:"#hintsCondition1",delay:pr+3e3,duration:500,opacity:1}),lr=!0,d3.timeout(function(){_t(!0),Tt(!0)},pr),Ga=!1}function zt(pr){for(var gr,yr=Ua.append("g").attr("id","stories-final"),ur=["cecile","klaus","jakub","alejandro","francesca","ileana"],hr=4e3,mr=0;mr<ur.length;mr++)gr=ur[mr],yr.append("path").data([storyScript[gr].path]).attr("id","journey-path-final-"+gr).attr("fill","none").attr("stroke","hsl(300,90%,25%)").attr("stroke-width",6).attr("d",d3.line().curve(d3.curveBasis)).attr("stroke-dasharray",tr[gr]).attr("stroke-dashoffset",0).style("opacity",0).transition().duration(pr).duration(hr).style("opacity",1);Ua.selectAll(".storygroup").transition().delay(pr+hr).style("opacity",0).remove()}function Ht(pr){for(var gr,yr=[{name:"cecile",x:235,y:305},{name:"klaus",x:290,y:240},{name:"jakub",x:350,y:180},{name:"alejandro",x:120,y:350},{name:"francesca",x:270,y:380},{name:"ileana",x:390,y:280}],ur=Ua.append("g").attr("id","final-icons").style("opacity",0),hr=Ua.node().getBoundingClientRect(),mr=0;mr<yr.length;mr++)gr=d3.select("#select-image-"+yr[mr].name).node().getBoundingClientRect(),ur.append("image").attr("id","final-icon-"+yr[mr].name).data([yr[mr]]).attr("href",ir[yr[mr].name]).attr("xlink:href",ir[yr[mr].name]).attr("height",gr.height).attr("width",gr.width).attr("x",gr.x-hr.x).attr("y",gr.y-hr.y);fe({selector:"#final-icons",opacity:1,delay:pr,duration:100}),fe({selector:"#journeySelection",opacity:0,delay:pr+100,duration:2e3}),ur.selectAll("image").transition().delay(pr+2e3).duration(6e3).attr("height",30).attr("x",function(fr){return fr.x}).attr("y",function(fr){return fr.y}).on("end",function(){fe({selector:"#final-icons",opacity:0,delay:0,duration:3e3})})}function qt(){o("Z"),Ft(!1),fe({selector:"#storyTextC2",opacity:0,delay:0,duration:1e3}),d3.selectAll("#netFlowsAll, #netFlowsSelected, .chapter_group").transition().duration(1e3).style("opacity",0).remove(),fe({selector:"#hintsCondition2",opacity:0,delay:0,duration:1e3}),cr.highlightCountries({selector:".eu",flag:!1});var pr=1e3;fe({selector:".flow_group",delay:pr,duration:2e3,opacity:1}),fe({selector:".infoModal",delay:pr,duration:800,opacity:1}),pr+=1e3,fe({selector:"#slider",delay:pr,duration:2e3,opacity:0.3}),fe({selector:"#chart",delay:pr,duration:2e3,opacity:1}),fe({selector:"#legend",delay:pr,duration:2e3,opacity:1}),fe({selector:"#toggleMode",delay:pr,duration:2e3,opacity:1}),fe({selector:"#toggleHowTo",delay:pr,duration:2e3,opacity:1}),fe({selector:"#hintsCondition1",delay:pr+3e3,duration:500,opacity:1}),lr=!0,d3.timeout(function(){_t(!0),Tt(!0)},pr)}function Nt(pr){if(!(Ve<=Ke[Te-1].length-1))Ne.stop(),_t(!1),o("H"),_e.setEmbeddedData("log",JSON.stringify(je)),Ie.clickNextButton();else if(pr<=Ke[Te-1][Ve])wt(Ke[Te-1][Ve]-pr);else{if(Ve!=Ke[Te-1].length-1)if(2===Te)Ne.stop(),Pe.text(""),qt();else if(3===Te)if(Ne.stop(),Pe.text(""),Ga=!0,Ka){var yr=Xa-(d3.now()-Ja);d3.timeout(function(){fe({selector:"#hintsCondition3",delay:0,duration:500,opacity:0}),d3.selectAll(".storyButton").classed("transition",!0).on("click",null).on("mousemove",null).on("mouseout",null)},yr-5e3)}else Dt();Ve++}}function Kt(){lr?(o("B0"),ar.interrupt().transition(),void 0!=sr&&(sr.stop(),sr=void 0),fe({selector:"#hintsCondition1",delay:0,duration:0,opacity:0}),lr=!1,d3.select("#toggleHowTo").html("Show hints")):(o("B1"),fe({selector:"#hintsCondition1",delay:0,duration:0,opacity:1}),lr=!0,d3.select("#toggleHowTo").html("Hide hints"))}function Vt(){na?(o("C1"),(Fa=Ca,La=Ma),d3.select("#toggleMode").html("Combine all years").classed("active",!0),Fe.removeAttribute("disabled"),Fe.style.opacity="1.0",na=!1,la?lt([sa],We,We,!0):lt(flowData,We,We,!0)):(o("C0"),Fa=Oa,La=Ra,Fe.setAttribute("disabled",!0),Fe.style.opacity="0.3",d3.select("#toggleMode").html("Show by years").classed("active",!1),na=!0,la?lt([sa],0,Ze,!0):lt(flowData,0,Ze,!0)),kt(),M(),k(),st(),la&&A()}function Gt(){var pr=100*qe/He;d3.select("#chapterProgress").style("background","linear-gradient(left, rgba(128, 0, 128, 0.5) "+pr+"%, transparent "+pr+"%)").style("background","-webkit-linear-gradient(left, rgba(128, 0, 128, 0.5) "+pr+"%, transparent "+pr+"%)").style("background","-moz-linear-gradient(left, rgba(128, 0, 128, 0.5) "+pr+"%, transparent "+pr+"%)").style("background","-ms-linear-gradient(left, rgba(128, 0, 128, 0.5) "+pr+"%, transparent "+pr+"%)")}function Jt(pr){var yr=qe;0>pr?(qe--,qe=Math.max(ze,qe),o("I"+qe)):(qe++,qe=Math.min(He,qe),o("J"+qe)),yr!=qe&&storyScript.chapters[qe].forEach(function(ur){d3.select(ur.args.selector).interrupt().transition(),window.Flowstory[ur.func](ur.args)})}function Xt(pr){Ka&&!Va?(o("Y"+pr.charAt(0).toUpperCase()),Ua.select("#journey-path-"+pr).interrupt().transition(),te(pr)):(o("W"+pr.charAt(0).toUpperCase()),ee(pr))}function Wt(pr){Ua.select("#journey-path-"+pr).attr("stroke","hsl(300,40%,70%)")}function Zt(pr){Ua.select("#journey-path-"+pr).attr("stroke","hsl(300,90%,25%)")}function Qt(){d3.selectAll(".storyButton").classed("deactivate",!1).on("click",function(pr){Xt(pr)}).on("mousemove",function(pr){Wt(pr)}).on("mouseout",function(pr){Zt(pr)}),d3.select("#journeySelection").style("background-color","rgba(245,245,245,0.8)")}function $t(pr){d3.selectAll(".storyButton:not(#storyButton-"+pr+")").classed("deactivate",!0).on("click",null),d3.selectAll(".storyButton").on("mousemove",null).on("mouseout",null),d3.select("#journeySelection").style("background-color","rgba(245,245,245,0.2)")}function te(pr){Za.forEach(function(ur){clearTimeout(ur)}),Za=[],Ka=!1,Qa=null,Xa=null;var yr=Ua.select("g#story-"+pr);$a.includes(pr)?(yr.selectAll("*:not(.journey-path)").remove(),yr.select(".journey-path").transition(),yr.select(".journey-path").transition().delay(1).duration(0).attr("stroke-dashoffset",0).attr("stroke-dasharray",tr[pr])):yr.remove(),d3.selectAll(".journey-path").attr("stroke","hsl(300,90%,25%)"),Oe.interrupt().transition(),Oe.style("opacity",0).style("visibility","hidden"),fe({selector:"#storyFocusMask",opacity:0,delay:0,duration:0}),Qt(),Va=!0,Ga&&Dt()}function ee(pr){Qa=pr,$t(pr),Za.forEach(function(hr){clearTimeout(hr)}),Za=[];var yr=Ua.select("g#story-"+pr);yr.empty()?yr=Ua.append("g").attr("id","story-"+pr).attr("class","storygroup"):yr.selectAll("*").remove(),dt(storyScript[pr].focusMask),xt(storyScript[pr].storyText),Ka=!0,Va=!1;var ur=storyScript[pr].events.length;Ja=d3.now(),storyScript[pr].events.forEach(function(hr,mr){if(hr.args.name=pr,window.Flowstory[hr.func](hr.args),mr===ur-3){var gr=setTimeout(function(){Qt(),Va=!0},hr.args.delay);Za.push(gr)}if(mr===ur-1){Xa=hr.args.delay+hr.args.duration;var gr=setTimeout(function(){o("X"+pr.charAt(0).toUpperCase()),te(pr)},Xa);Za.push(gr)}})}function ae(pr){var yr=storyScript[pr.name].marker[pr.id],ur=storyScript[pr.name].path[yr.posIdx];Ua.select("g#story-"+pr.name).append("image").attr("id",pr.id+"-"+pr.name).attr("class","marker").attr("xlink:href",yr.src).attr("width",yr.width).attr("height",yr.height).attr("transform","translate("+(ur[0]+("dx"in yr?yr.dx:0)-yr.width/2)+","+(ur[1]+("dy"in yr?yr.dx:0)-yr.height/2)+")").style("visibility","hidden").style("opacity",0)}function re(pr){var yr=Ua.select("g#story-"+pr.name).append("path").data([storyScript[pr.name].path]).attr("id","journey-path-"+pr.name).attr("class","journey-path").attr("fill","none").attr("stroke","hsl(300,90%,25%)").attr("stroke-width",6).attr("d",d3.line().curve(d3.curveBasis)),ur=yr.node().getTotalLength();yr.attr("stroke-dasharray",ur+" "+ur).attr("stroke-dashoffset",ur)}function ne(pr){Ua.select("g#story-"+pr.name).append("path").data([storyScript[pr.name].pathReverse]).attr("id","journey-path-reverse-"+pr.name).attr("fill","none").attr("stroke","none").attr("d",d3.line().curve(d3.curveBasis))}function le(pr){d3.selectAll(".journey-path:not(#journey-path-"+pr.name+")").transition().delay(pr.delay).duration(pr.duration).attr("stroke",pr.color)}function se(pr){Ua.select("#journey-path-"+pr.name).transition().delay(pr.delay).duration(pr.duration).ease(d3.easeSin).attr("stroke-dashoffset",0).attr("stroke-dasharray",tr[pr.name]).on("end",function(){$a.includes(pr.name)||$a.push(pr.name)})}function oe(pr){Ua.select("#"+pr.marker+"-"+pr.name).transition().delay(pr.delay).duration(pr.duration).ease(d3.easeSin).attrTween("transform",ie(Ua.select(pr.pathSelector).node(),storyScript[pr.name].marker[pr.marker].height,storyScript[pr.name].marker[pr.marker].width))}function ie(pr,yr,ur){var hr=pr.getTotalLength();return function(){return function(gr){var fr=pr.getPointAtLength(gr*hr);return"translate("+(fr.x-ur/2)+","+(fr.y-yr/2)+")"}}}function de(pr){d3.select("#title").transition().delay(pr.delay).duration(pr.duration).style("top",pr.top).style("left",pr.left)}function ce(pr){var yr=0;return yr=0==pr.balance&&0!=pr["in"]&&0!=pr.out?ea:(aa-ea)*(Math.abs(pr.balance)-Ca)/(Ma-Ca)+ea,yr}function pe(pr){var yr=0;return yr=0==pr.balance&&0!=pr["in"]&&0!=pr.out?ea:na||ra?(aa-ea)*(Math.abs(pr.balance)-Fa)/(La-Fa)+ea:(aa-ea)*(Math.abs(pr.balance)-Fa[We])/(La[We]-Fa[We])+ea,yr}function ye(pr,yr){var ur=0;return 0!=pr[yr]&&(na||ra?ur=(aa-ea)*(Math.abs(pr[yr])-Fa)/(La-Fa)+ea:ur=(aa-ea)*(Math.abs(pr[yr])-Fa[We])/(La[We]-Fa[We])+ea),ur}function ue(pr,yr){var ur=0;return 0!=pr[yr]&&(ur=(aa-ea)*(Math.abs(pr[yr])-Ca)/(Ma-Ca)+ea),ur}function he(pr,yr){var ur=0;return 0!=pr[yr]&&(ur=(aa-ea)*(Math.abs(pr[yr])-Oa)/(Ra-Oa)+ea),ur}function me(pr,yr,ur,hr){var mr=0;return 0!=pr[yr]&&(mr=(aa-ea)*(Math.abs(pr[yr])-ur)/(hr-ur)+ea),mr}function ge(pr,yr){return void 0!==pr&&yr.includes(pr)?pr:yr[0]}function fe(pr){var yr=d3.selectAll(pr.selector);yr.transition().delay(pr.delay).duration(pr.duration).style("visibility","visible").style("opacity",pr.opacity),0==pr.opacity&&yr.transition().delay(pr.delay+pr.duration).duration(0).style("visibility","hidden")}function xe(pr,yr,ur){var hr=yr.getBBox(),mr=yr.getCTM(),gr=2;d3.selectAll("."+ur).style("opacity",0).remove();var fr=pr.append("rect","text").attr("class",ur).attr("x",hr.x-gr).attr("y",hr.y-gr).attr("width",hr.width+2*gr).attr("height",hr.height+2*gr).style("fill","yellow").style("opacity",0.3);fr.node().transform.baseVal.initialize(fr.node().ownerSVGElement.createSVGTransformFromMatrix(mr)),fr.transition().duration(800).ease(d3.easeExp).style("opacity",0).remove()}function be(pr,yr,ur,hr){var mr=yr.getBBox(),gr=yr.getCTM(),fr=4,xr=pr.append("rect","text").attr("class",ur).attr("x",mr.x-fr).attr("y",mr.y-fr).attr("width",mr.width+2*fr).attr("height",mr.height+2*fr).attr("fill",hr).attr("rx",4).attr("ry",4).attr("stroke",hr).attr("stroke-width",2).style("fill-opacity",0.3).style("stroke-opacity",0.8);xr.node().transform.baseVal.initialize(xr.node().ownerSVGElement.createSVGTransformFromMatrix(gr))}function ve(pr,yr,ur,hr){var mr=yr.getBBox(),gr=yr.getCTM(),fr=2,xr=pr.append("rect","text").attr("class",ur).attr("x",mr.x-fr).attr("y",mr.y-fr).attr("width",mr.width+2*fr).attr("height",mr.height+2*fr).attr("fill",hr).attr("rx",2).attr("ry",2);xr.node().transform.baseVal.initialize(xr.node().ownerSVGElement.createSVGTransformFromMatrix(gr))}function we(pr,yr,ur,hr){var mr=Math.PI-Math.atan2(pr[0]-yr[0],pr[1]-yr[1]),gr=[pr[0]-hr*Math.cos(mr),pr[1]-hr*Math.sin(mr)],fr=Math.PI-Math.atan2(pr[0]-ur[0],pr[1]-ur[1]),xr=[yr[0]-hr*Math.cos(fr),yr[1]-hr*Math.sin(fr)],br=Math.PI-Math.atan2(yr[0]-ur[0],yr[1]-ur[1]),vr=[ur[0]-hr*Math.cos(br),ur[1]-hr*Math.sin(br)];return[gr,xr,vr]}function ke(pr){var yr;return flowData.forEach(function(ur){ur.cc==pr&&(yr=ur)}),yr}function Ae(pr,yr){var ur=d3.selectAll(pr).nodes(),hr=[];return ur.forEach(function(mr){var gr=d3.select(mr),fr=d3.select(mr.cloneNode(!0)).data(gr.data()).attr("id",gr.attr("id")+"_"+yr).attr("class",gr.attr("class")).attr("d",gr.attr("d"));hr.push(fr)}),hr}var Te,Ie,_e,Le,Fe,Me,Ce,Se,Pe,Re,Oe,Ee,He,Ne,sa,ua,ha,ma,ga,fa,xa,ba,va,wa,ka,Aa,Ta,Ia,_a,Ua,Ja,Xa,ar,rr,nr,sr,je={},Ye={},ze=0,qe=0,Ke=[[480000],[300000,180000],[270000,180000]],Ve=0,Ge=d3.format(".2s"),Je=d3.format(".1s"),Xe=Math.PI,We=0,Ze=16,Qe=2e3,$e=2e3,ta=2016,ea=2,aa=30,ra=!0,na=!0,la=!1,oa=[],ia={AUT:2000,BEL:2000,DNK:2000,FIN:2000,FRA:2000,DEU:2000,GRC:2000,ITA:2000,LUX:2000,NLD:2000,PRT:2000,IRL:2000,ESP:2000,SWE:2000,CYP:2004,CZE:2004,EST:2004,HUN:2004,LVA:2004,LTU:2004,MLT:2004,POL:2004,SVK:2004,SVN:2004,BGR:2007,ROU:2007,HRV:2013},da="all",ca=["job","looking","study","join"],ya={job:{"in":"#bebada",out:"#fb9a99"},looking:{"in":"#d1cbd6",out:"#fdbf6f"},study:{"in":"#b3de69",out:"#b2df8a"},join:{"in":"#8dd3c7",out:"#a6cee3"}},La=0,Fa=0,Ma=0,Ca=999999,Sa=0,Pa=999999,Ra=0,Oa=999999,Ea=0,ja=999999,Ya=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Ba=[999999,999999,999999,999999,999999,999999,999999,999999,999999,999999,999999,999999,999999,999999,999999,999999,999999],Da=d3.geoPath(),za="ne_50m_admin_0_clip2",Ha="cityunilondon.eu.qualtrics.com"===window.location.hostname?"https://cityunilondon.eu.qualtrics.com/ControlPanel/File.php?F=F_4V0IleE4gtYT68R":"data/"+za+".json",qa=d3.geoConicEquidistant().parallels([41,65]).center([0,53]).precision(.1).rotate([-14,0]).scale(1100).translate([410,250]),Na=d3.line().curve(d3.curveBasis),Ka=!1,Va=!0,Ga=!1,Za=[],Qa=null,$a=[],tr={cecile:95,klaus:100,jakub:220,alejandro:190,francesca:285,ileana:330},lr=!1,or="cityunilondon.eu.qualtrics.com"===window.location.hostname?"https://cityunilondon.eu.qualtrics.com/ControlPanel/File.php?F=F_4MKj6D6mLdcc5RX":"data/icons/hints/arrow_curved.svg",ir="cityunilondon.eu.qualtrics.com"===window.location.hostname?{cecile:"https://cityunilondon.eu.qualtrics.com/ControlPanel/File.php?F=F_204D8mBuBZlCSJD",klaus:"https://cityunilondon.eu.qualtrics.com/ControlPanel/File.php?F=F_eyTqtsCOCUeXvHT",jakub:"https://cityunilondon.eu.qualtrics.com/ControlPanel/File.php?F=F_eXKv0Wbikcekv1H",alejandro:"https://cityunilondon.eu.qualtrics.com/ControlPanel/File.php?F=F_5j3udMctHIa3Jf7",francesca:"https://cityunilondon.eu.qualtrics.com/ControlPanel/File.php?F=F_9AET5SAsFx13gq1",ileana:"https://cityunilondon.eu.qualtrics.com/ControlPanel/File.php?F=F_6mwB7i22IbQWEAZ"}:{cecile:"data/icons/selection/cecile.svg",klaus:"data/icons/selection/klaus.svg",jakub:"data/icons/selection/jakub.svg",alejandro:"data/icons/selection/alejandro.svg",francesca:"data/icons/selection/francesca.svg",ileana:"data/icons/selection/ileana.svg"},cr={};return cr.initFlowstory=function(pr,yr,ur,hr){o("A"+pr),Te=pr,2===Te&&(He=void 0!=storyScript&&void 0!=storyScript.chapters?storyScript.chapters.length-1:void 0),Ie=ur,_e=hr,Le=d3.select("#"+yr).html(null),Ua=Le.append("svg").attr("id","svgMap"),u(),m(),2===Te?S():3===Te?P():C(),Ne=d3.timer(function(mr){Nt(mr)}),F()},cr.fadeElementToOpacity=function(pr){fe(pr)},cr.setJourneyPathsColor=function(pr){le(pr)},cr.createJourneyPath=function(pr){re(pr)},cr.createJourneyPathReverse=function(pr){ne(pr)},cr.createMarker=function(pr){ae(pr)},cr.updateStoryTextFadeIn=function(pr){yt(pr)},cr.updateStoryTextAndStyleFadeIn=function(pr){ut(pr)},cr.updateStoryTextAndStyleCrossFade=function(pr){ht(pr)},cr.updateStoryTextAndStyleCrossFadeC2=function(pr){gt(pr)},cr.updateStoryTextCrossFade=function(pr){pt(pr)},cr.moveMarkerAlongPath=function(pr){oe(pr)},cr.animateJourneyPath=function(pr){se(pr)},cr.updateStoryTextPosition=function(pr){xt(pr)},cr.updateStoryTextStyle=function(pr){bt(pr)},cr.moveTitleTo=function(pr){de(pr)},cr.enableMapEvents=function(pr){d3.timeout(function(){Tt(pr.flag)},pr.delay)},cr.enableMouseDownEvent=function(pr){d3.timeout(function(){Mt(),_t(pr.flag)},pr.delay)},cr.toggleModeIfByYear=function(){na||Vt()},cr.toggleMode=function(){Vt()},cr.inOutFlow=function(pr){Pt(Ce.select("#F_"+pr.cc).data()[0],pr.cc),Me.style("display","none")},cr.removeInOutFlow=function(){Mt()},cr.showHints=function(pr){var yr=Ua.append("g").attr("id","hints").style("opacity",0)},cr.removeHints=function(pr){d3.select("g#hints").transition().delay(pr.delay).duration(pr.duration).style("opacity",0).remove()},cr.hideHintsC1IfVisible=function(){lr&&Kt()},cr.showHintsC1=function(){d3.timeout(function(){Kt()},1e3)},cr.updateFlows=function(){k(!1)},cr.updateFlowsUsingYears=function(pr){d3.timeout(function(){k(!1,pr.fromYearIdx,pr.toYearIdx)},pr.delay)},cr.drawNetFlowsforSelectionByYears=function(pr){if(Ua.select("#"+pr.id).empty()){var yr=Ae(pr.selector,pr.id),ur=Ua.append("g").attr("class","chapter_flow_group chapter_group").attr("id",pr.id);yr.forEach(function(hr){ur.node().append(hr.node())}),ur.selectAll("path.flow").each(function(hr){var fr=!1,xr=!1,br=!1,vr=!1,wr=T(hr,pr.fromYearIdx,pr.toYearIdx),kr=pe(wr);0==wr.balance?0==wr["in"]&&0==wr.out?vr=!0:br=!0:0>wr.balance?xr=!0:0<wr.balance&&(fr=!0),vr?d3.select(this).transition().duration(200).style("opacity",0).transition().delay(200).style("visibility","hidden").attr("stroke-width",kr):d3.select(this).classed("in",fr).classed("out",xr).classed("equal",br).transition().duration(200).style("opacity",1).style("visibility","visible").attr("stroke-width",kr)})}},cr.drawOrUpdateInOutFlowForSelectionByYears=function(pr){var yr=Ua.select("g#"+pr.id);yr.empty()?(yr=Ua.append("g").attr("class","chapter_flow_inout chapter_group").attr("id",pr.id),pr.selector.forEach(function(ur){var hr=ke(ur),mr=T(hr,pr.fromYearIdx,pr.toYearIdx);if(pr.scaleMode&&"aggregate"===pr.scaleMode)var gr=he(mr,"in"),fr=he(mr,"out");else if(pr.scaleMode&&"local"===pr.scaleMode)var xr=Math.min(...Ba.slice(pr.fromYearIdx,pr.toYearIdx+1)),br=Math.max(...Ya.slice(pr.fromYearIdx,pr.toYearIdx+1)),gr=me(mr,"in",xr,br),fr=me(mr,"out",xr,br);else var gr=ue(mr,"in"),fr=ue(mr,"out");var kr=Na(we([hr.sp.x,hr.sp.y],hr.cp_moved,[hr.ep.x,hr.ep.y],gr/2+2)),Ar=Na(we([hr.sp.x,hr.sp.y],hr.cp_moved,[hr.ep.x,hr.ep.y],-fr/2-2)),Tr=yr.append("path").attr("class","inPath").attr("id","inPath"+ur).attr("d",kr).attr("fill","none").attr("stroke","hsl(355, 80%, 50%)").attr("stroke-linecap","butt").attr("stroke-width",gr),Ir=Tr.node().getTotalLength(),_r=Tr.node().getPointAtLength(Ir),Lr=yr.append("path").attr("class","outPath").attr("id","outPath"+ur).attr("d",Ar).attr("fill","none").attr("stroke","hsl(215, 80%, 50%)").attr("stroke-linecap","butt").attr("stroke-width",fr),Fr=Lr.node().getTotalLength(),Mr=Lr.node().getPointAtLength(0),Cr=1e3;Tr.attr("stroke-dasharray",Ir+" "+Ir).attr("stroke-dashoffset",Ir).transition().duration(Cr).ease(d3.easeSin).attr("stroke-dashoffset",0).on("end",void 0!=pr.drawAnnotation&&!1==pr.drawAnnotation?null:function(){var Sr=yr.append("text").attr("id","annotationIn"+ur).attr("transform","translate("+_r.x+" "+_r.y+")").attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-weight","bolder").text(Ge(mr["in"]));Sr.node()&&be(yr,Sr.node(),"volumeAnnotation","red")}),Lr.attr("stroke-dasharray",Fr+" "+Fr).attr("stroke-dashoffset",-Fr).transition().duration(Cr).ease(d3.easeSin).attr("stroke-dashoffset",0).on("end",void 0!=pr.drawAnnotation&&!1==pr.drawAnnotation?null:function(){var Sr=yr.append("text").attr("id","annotationOut"+ur).attr("transform","translate("+Mr.x+" "+Mr.y+")").attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-weight","bolder").text(Ge(mr.out));Sr.node()&&be(yr,Sr.node(),"volumeAnnotation","blue")})})):(yr.selectAll("rect").remove(),pr.selector.forEach(function(ur){var hr=ke(ur),mr=T(hr,pr.fromYearIdx,pr.toYearIdx);if(pr.scaleMode&&"aggregate"===pr.scaleMode)var gr=he(mr,"in"),fr=he(mr,"out");else if(pr.scaleMode&&"local"===pr.scaleMode)var xr=Math.min(...Ba.slice(pr.fromYearIdx,pr.toYearIdx+1)),br=Math.max(...Ya.slice(pr.fromYearIdx,pr.toYearIdx+1)),gr=me(mr,"in",xr,br),fr=me(mr,"out",xr,br);else var gr=ue(mr,"in"),fr=ue(mr,"out");var kr=Na(we([hr.sp.x,hr.sp.y],hr.cp_moved,[hr.ep.x,hr.ep.y],gr/2+2)),Ar=Na(we([hr.sp.x,hr.sp.y],hr.cp_moved,[hr.ep.x,hr.ep.y],-fr/2-2)),Tr=d3.select("#inPath"+ur).attr("stroke-dasharray","").transition().duration(200).attr("d",kr).attr("stroke-width",gr).on("end",function(){var _r=Tr.node().getTotalLength(),Lr=Tr.node().getPointAtLength(_r),Fr=d3.select("#annotationIn"+ur).attr("transform","translate("+Lr.x+" "+Lr.y+")").text(Ge(mr["in"]));Fr.node()&&be(yr,Fr.node(),"volumeAnnotation","red")}),Ir=d3.select("#outPath"+ur).attr("stroke-dasharray","").transition().duration(200).attr("d",Ar).attr("stroke-width",fr).on("end",function(){var _r=Ir.node().getPointAtLength(0),Lr=d3.select("#annotationOut"+ur).attr("transform","translate("+_r.x+" "+_r.y+")").text(Ge(mr.out));Lr.node()&&be(yr,Lr.node(),"volumeAnnotation","blue")})}))},cr.drawInOutFlowForSelectionByYears=function(pr){var yr=Ua.append("g").attr("class","chapter_flow_inout chapter_group").attr("id",pr.id);pr.selector.forEach(function(ur){var hr=ke(ur),mr=T(hr,pr.fromYearIdx,pr.toYearIdx);if(pr.scaleMode&&"aggregate"===pr.scaleMode)var gr=he(mr,"in"),fr=he(mr,"out");else if(pr.scaleMode&&"local"===pr.scaleMode)var xr=Math.min(...Ba.slice(pr.fromYearIdx,pr.toYearIdx+1)),br=Math.max(...Ya.slice(pr.fromYearIdx,pr.toYearIdx+1)),gr=me(mr,"in",xr,br),fr=me(mr,"out",xr,br);else var gr=ue(mr,"in"),fr=ue(mr,"out");var kr=Na(we([hr.sp.x,hr.sp.y],hr.cp_moved,[hr.ep.x,hr.ep.y],gr/2+2)),Ar=Na(we([hr.sp.x,hr.sp.y],hr.cp_moved,[hr.ep.x,hr.ep.y],-fr/2-2)),Tr=yr.append("path").attr("class","inPath").attr("id","inPath"+ur).attr("d",kr).attr("fill","none").attr("stroke","hsl(355, 80%, 50%)").attr("stroke-linecap","butt").attr("stroke-width",gr),Ir=Tr.node().getTotalLength(),_r=Tr.node().getPointAtLength(Ir),Lr=yr.append("path").attr("class","outPath").attr("id","outPath"+ur).attr("d",Ar).attr("fill","none").attr("stroke","hsl(215, 80%, 50%)").attr("stroke-linecap","butt").attr("stroke-width",fr),Fr=Lr.node().getTotalLength(),Mr=Lr.node().getPointAtLength(0),Cr=1e3;Tr.attr("stroke-dasharray",Ir+" "+Ir).attr("stroke-dashoffset",Ir).transition().duration(Cr).ease(d3.easeSin).attr("stroke-dashoffset",0).on("end",void 0!=pr.drawAnnotation&&!1==pr.drawAnnotation?null:function(){var Sr=yr.append("text").attr("id","annotationIn"+ur).attr("transform","translate("+_r.x+" "+_r.y+")").attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-weight","bolder").text(Ge(mr["in"]));Sr.node()&&be(yr,Sr.node(),"volumeAnnotation","red")}),Lr.attr("stroke-dasharray",Fr+" "+Fr).attr("stroke-dashoffset",-Fr).transition().duration(Cr).ease(d3.easeSin).attr("stroke-dashoffset",0).on("end",void 0!=pr.drawAnnotation&&!1==pr.drawAnnotation?null:function(){var Sr=yr.append("text").attr("id","annotationOut"+ur).attr("transform","translate("+Mr.x+" "+Mr.y+")").attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-weight","bolder").text(Ge(mr.out));Sr.node()&&be(yr,Sr.node(),"volumeAnnotation","blue")})})},cr.updateInOutFlowForSelectionByYears=function(pr){var yr=d3.select("#"+pr.id);yr.selectAll("rect").remove(),pr.selector.forEach(function(ur){var hr=ke(ur),mr=T(hr,pr.fromYearIdx,pr.toYearIdx),gr=ue(mr,"in"),fr=ue(mr,"out"),vr=Na(we([hr.sp.x,hr.sp.y],hr.cp_moved,[hr.ep.x,hr.ep.y],gr/2+2)),wr=Na(we([hr.sp.x,hr.sp.y],hr.cp_moved,[hr.ep.x,hr.ep.y],-fr/2-2)),kr=d3.select("#inPath"+ur).attr("stroke-dasharray","").transition().duration(200).attr("d",vr).attr("stroke-width",gr).on("end",function(){var Tr=kr.node().getTotalLength(),Ir=kr.node().getPointAtLength(Tr),_r=d3.select("#annotationIn"+ur).attr("transform","translate("+Ir.x+" "+Ir.y+")").text(Ge(mr["in"]));_r.node()&&be(yr,_r.node(),"volumeAnnotation","red")}),Ar=d3.select("#outPath"+ur).attr("stroke-dasharray","").transition().duration(200).attr("d",wr).attr("stroke-width",fr).on("end",function(){var Tr=Ar.node().getPointAtLength(0),Ir=d3.select("#annotationOut"+ur).attr("transform","translate("+Tr.x+" "+Tr.y+")").text(Ge(mr.out));Ir.node()&&be(yr,Ir.node(),"volumeAnnotation","blue")})})},cr.removeInOutFlowGroup=function(pr){d3.select(pr.selector).remove()},cr.addYearButtonsToStoryText=function(pr){d3.timeout(function(){for(var yr=Oe.append("div"),ur=pr.fromYearIdx;ur<=pr.toYearIdx;ur++)yr.append("button").html(2e3+ur).data([ur]).style("background-color",ur==pr.startIdx?"#999":"#eee").on("click",function(hr){yr.selectAll("button").style("background-color","#eee"),d3.select(this).style("background-color","#999"),cr.updateInOutFlowForSelectionByYears({selector:[pr.cc],id:pr.id,delay:0,duration:1e3,opacity:1,fromYearIdx:hr,toYearIdx:hr})})},pr.delay)},cr.shrinkAndMoveIcons=function(){Ht(0)},cr.highlightCountries=function(pr){Ua.selectAll(pr.selector).classed("selected",pr.flag)},cr.removeElement=function(pr){d3.selectAll(pr.selector).remove()},cr}();